---
title: "Aplicaciones con geo-datos: Parte I"
subtitle: "Curso: Introducción al análisis espacial y web-mapping <br>con Google Earth Engine y R Shiny<br>"
author: "Mg. José A. Lastra <br>Matías Olea<br>"
institute: "Laboratorio Geo-Información y Percepción Remota"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  xaringan::moon_reader:
    css: [fc]
    lib_dir: libs
    nature:
      highlightStyle: zenburn
      ratio: '16:9'
      highlightLines: true
      countIncrementalSlides: false
      beforeInit: "macros.js"

---
background-image: url(logo_labgrs_color.png)
background-position: center
background-size:40%

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(tidyverse)
library(sf)
library(rgdal)
library(raster)
library(plotly)
library(leaflet)
library(kableExtra)

```


---

Librerías utilizadas en esta sesión

```{r eval=F}
library(shiny)
library(tidyverse)
library(sf)
library(rgdal)
library(raster)
library(plotly)
library(leaflet)
```

---
# Estructurando nuestra app

--
- De momento, hemos utilizado la página fluída (fluidPage) en nuestra aplicación inicial con datos.

--
- Una mejor alternativa es el uso de las páginas de tipo bootstrap (bootstrapPage) ya que:
  + Se integra eficientemente con JavaScript (sobre todo si posteriormente personalizamos nuestra página)
  + Compatibe con la mayoría de los navegadores
  + Responsive

---
# Diagrama general

--
- Primero configuraremos el cuerpo general del script y para poder emplear nuestro mapa a página completa emplearemos *tags*

--
- Nuestro mapa base lo haremos con *leatletOutput()*

--
- Leeremos nuestras capas de información vectorial y la reproyectaremos de inmediato para operar en leaflet

---
```{r eval=F}
library(shiny)
library(tidyverse)
library(sf)
library(rgdal)
library(raster)
library(plotly)
library(leaflet)
########### UI #######################
ui <- bootstrapPage(
  tags$style(type = "text/css", "html, body {width:100%;height:100%}"),
  leafletOutput('map', width = "100%", height = "100%")
)
############SERVER###################
server <- function(input, output, session) {
  #Load data
  valpo <- read_sf('censoINE_Valparaiso2017.gpkg') %>% st_transform(4326)
  ## rendering base map
  output$map <- renderLeaflet({
    leaflet() %>% addProviderTiles(providers$CartoDB.DarkMatter) %>% 
      fitBounds(lng1 =-109.5 ,lat1 =-33.96 ,lng2 =-69.9 ,lat2 = -26.29) #ajustar extensión inicial del mapa
  })
}
##########Compile####################
shinyApp(ui,server)
```

--
- *fitBounds()* nos permite fijar la extensión inicial del mapa base

---
class: middle, center
![:scale 75%](app1.1.png)

---
# Antes de empezar

- Además de utilizar eventos puestos en la UI (sliders, select inputs, acction buttons, etc.), podemos hacer uso de eventos de mapa y objeto para pasarlos por el server.

--
- Los eventos de objeto se configuran así `input$MAPID_OBJCATEGORY_EVENTNAME` donde:
  + MAPID: nombre del mapa;
  + OBJCATEGORY: tipo de elemento para pasaro por el evento reactivo (marker, shape, geojson o topojson);
  + EVENTNAME: reacción al mouse (click, mouseover y mouseout)

--
- Los eventos de mapa se configuran así `input$MAPID_EVENTNAME` donde las opciones de evento disponibles son:
  + Click;
  + Bounds;
  + Zoom;
  + Center;

- Usaremos algunos de estos eventos durante el desarrollo de nuestra aplicación

---
# Incorporando Elementos en la UI

--
- Agregaremos un panel donde pondremos nuestras opciones

--
- Importante conocer esto sobre los paneles y su posición en la página [Más info.](https://leafletjs.com/reference-1.7.1.html#map-pane)

--
- Usaremos un panel que irá sobre nuestro mapa e iremos incorporando opciones en el. 

--
```{r, eval=F}
absolutePanel(id="controls",
                style="z-index:500;", top = 90, left = "auto", right = 20, 
                bottom = "auto",
                width = 400, height ="auto",
                class = "panel panel-default"
                )
```

--
- El argumento *style = "z-index:500;"* controla la posición de nuestro panel en nuestra página.

--
- Es importante poner 500 para que el panel esté por sobre nuestro mapa de leaflet.

---
class: middle, center
![:scale 75%](app1.2.png)

---

--
- A continuación, incorporaremos la opción de seleccionar un campo para visualizar en el mapa como información temática.

--
- Es importante considerar que cada elemento en la UI va serparado por una coma y que podemos revisar los elementos disponibles en el siguiente [vínculo](https://shiny.rstudio.com/gallery/widget-gallery.html)

--
- Nuestros input los pondremos en el panel absoluto.

--
```{r eval=F}
absolutePanel(id="controls",
              style="z-index:500;", top = 90, left = "auto", right = 20,bottom = "auto",
              width = 400, height ="auto",class = "panel panel-default",
              selectInput(inputId = "campo",label = 'Seleccione un campo de la lista',
                          choices = c("T_HOM","T_MUJ","T_POB","T_VIV"), selected = "T_POB")
              )
```

--
- Puede usar diferentes elementos para definir las opciones (vectores, listas, caracteres, números, etc.)

--
- Lo importante es considerar la operación posterior en el server.

---
class: middle, center
![:scale 95%](app1.3.png)



---
background-image: url(logo_labgrs_color.png)
background-position: center
background-size:40%



